# Инструкция по сбору тегов и автозаполнению в статьях

Скрипт `collect_tags.py` выполняет две задачи:

1. **Сбор тегов** из Notion Database (поле типа Multi-Select) и сохранение в файл `tags.txt`.
2. **Автозаполнение тегов** в `.md` файлах из каталога `articles_markdown/` — вставка блока `**Компания:**` на основе упоминаний тегов в статьях.

---

## Быстрый старт

1. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Получите Notion API токен:**
   - Перейдите на https://www.notion.so/my-integrations
   - Создайте новую интеграцию
   - Скопируйте "Internal Integration Token"

3. **Подключите интеграцию к Database:**
   - Откройте вашу Database в Notion
   - Нажмите "..." → "Connections" → "Add connections"
   - Выберите вашу интеграцию

4. **Запустите скрипт:**

   **Способ 1: Через переменную окружения (рекомендуется)**
   ```bash
   export NOTION_TOKEN='your_token_here'
   python3 collect_tags.py
   ```

   **Способ 2: Через аргумент командной строки**
   ```bash
   python3 collect_tags.py your_token_here
   ```

   **Справка:**
   ```bash
   python3 collect_tags.py --help
   ```

---

## Часть 1 — Сбор тегов из Notion

### Как работает

1. Скрипт просит ввести **URL или ID Database**, содержащей теги.
2. Через Notion API получает структуру Database и выводит **все поля** с их типами. Поля типа `multi_select` отмечены символом `✓`.
3. Пользователь **выбирает поле** типа Multi-Select, из которого нужно собрать теги. Если такое поле единственное — оно берётся автоматически.
4. Скрипт выгружает **все страницы** из Database (с пагинацией по 100 штук за запрос), извлекает уникальные значения из выбранного Multi-Select property. Во время загрузки отображается spinner с живым счётчиком страниц и тегов.
5. Уникальные теги сохраняются в файл `tags.txt` (один тег на строку, по алфавиту).

### Повторный запуск

Если файл `tags.txt` уже существует, скрипт предлагает:
- использовать существующие теги (без запроса к Notion),
- или пересобрать их заново.

### Формат tags.txt

```
Apple.
Discord.
Google.
Notion.
Tesla.
```

Один тег на строку, теги сохранены в том виде, в котором они хранятся в Notion (включая знаки в конце, если они есть).

---

## Часть 2 — Автозаполнение тегов в статьях

После сбора тегов скрипт переходит ко второй части. Пользователь может отменить её на промпте подтверждения.

### Шаг 1 — Проверка каталога

Скрипт проверяет наличие `.md` файлов в каталоге `articles_markdown/`. Если каталог пуст или не существует — скрипт завершается с сообщением.

### Шаг 2 — Нормализация тегов

Скрипт анализирует теги на наличие **знаков в конце** (например, `.`, `/` и т.д.):

```
  Обнаружены теги со знаками в конце:
--------------------------------------------------------------------------------
    Символ "."  (12 тег(ов)):
      • Apple.
      • Google.
      • Notion.
      ...
    Символ "/"  (2 тег(ов)):
      • Meta/
      • OpenAI/
--------------------------------------------------------------------------------
  Нормализовать теги (убрать знак в конце) перед поиском в статьях? [Y/n]:
```

- При **да**: знак убирается **только для поиска** — в `.md` файл теги записываются в оригинальном виде (как в Notion), чтобы при импорте обратно в Notion значения точно совпали.
- При **нет**: поиск идёт по тегам как есть (например, `Apple.` с точкой не найдётся в тексте `Apple raised...`).

### Шаг 3 — Область поиска

```
  Область поиска тегов:
    1. Название и тело статьи
    2. Название и первый абзац тела статьи
    3. Только название статьи
```

| Вариант | Где ищется |
|---|---|
| 1 | Заголовок (`# ...`) + всё тело статьи (после `---`) |
| 2 | Заголовок + только первый текстовый абзац тела (изображения в начале пропускаются) |
| 3 | Только заголовок |

### Шаг 4 — Учёт регистра

```
  Строгое соответствие регистра букв в тегах? [y/N]:
```

| Выбор | Пример: тег `Apple` |
|---|---|
| Строгий (y) | Найдёт только `Apple`. Не найдёт `apple`, `APPLE` |
| Без учёта (N) | Найдёт `Apple`, `apple`, `APPLE` и любой другой вариант |

По умолчанию — без учёта регистра.

### Шаг 5 — Обработка файлов

Для каждого `.md` файла:

- Если блок `**Компания:**` уже существует — файл **пропускается**.
- Иначе скрипт ищет совпадения тегов в заголовке и/или теле статьи (согласно настроенным параметрам).
- Если совпадения найдены — в файл добавляется блок `**Компания:**` с найденными тегами.

Итоги выводятся в конце: сколько файлов обработано, сколько тегов добавлено, сколько пропущено.

---

## Формат блока Компания в .md файлах

Блок вставляется в секцию метаданных — после строки `**Источник:**` и перед разделителем `---`:

```markdown
# Название статьи
**Дата публикации:** 02.02.2026
**Источник:** https://example.com/article
**Компания:** Apple., Google., Notion.

---

Тело статьи...
```

Теги перечислены через запятую, в том же формате, в котором они хранятся в Notion. Такая секция парсится аналогично `Дата публикации` и `Источник` — и в дальнейшем может быть использована при импорте в Notion как значение Multi-Select property.

---

## Устранение проблем

### Ошибка "Unauthorized"
- Проверьте правильность API токена (`NOTION_TOKEN`).
- Убедитесь, что интеграция подключена к нужной Database.

### Ошибка "Object not found"
- Проверьте правильность Database ID или URL, которые вы ввели.

### Ошибка "В Database не найдено data_sources"
- Убедитесь, что интеграция имеет доступ к Database и подключена через "Connections".

### Теги не находятся в статьях
- Проверьте, была ли включена нормализация. Если теги в Notion оканчиваются на `.` (например, `Apple.`), а поиск без нормализации — тег с точкой не совпадёт с текстом `Apple raised...`.
- Проверьте выбранную область поиска и настройку регистра.

### Блок Компания уже есть — скрипт пропускает файл
- Это штатное поведение: скрипт не перезаписывает существующий блок. Если нужно обновить теги — удалите строку `**Компания:**` из файла и запустите скрипт снова.
